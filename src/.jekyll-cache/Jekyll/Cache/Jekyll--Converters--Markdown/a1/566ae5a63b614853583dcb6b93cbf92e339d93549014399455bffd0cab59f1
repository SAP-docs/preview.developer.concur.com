I"9:<h1 id="event-subscription-management">Event Subscription Management</h1>

<div>
  <p><strong>Important</strong>: This API is currently in pre-release status and is only available to approved early access participants. The API is under development and might change before being generally released. To become an early access participant, contact your SAP Concur Representative.</p>
</div>

<ul>
  <li><a href="#ac-jwt">Access Control (JWT)</a></li>
  <li><a href="#get-topics">Browse available topics</a></li>
  <li><a href="#put-subscription">Create a subscription</a></li>
  <li><a href="#get-subscription">Verify your subscription</a></li>
  <li><a href="#get-subscription-list">Browse existing subscriptions</a></li>
  <li><a href="#delete-subscription">Delete your subscription</a></li>
  <li><a href="#example">Request Example</a></li>
</ul>

<h2 id="-1-access-control-jwt"><a name="ac-jwt"></a> 1. Access Control (JWT)</h2>
<p>The Event Subscription Service (ESS) APIs uses the standard Concur OAuth2 Framework for Authentication and Authorization via JSON Web Token (JWT).</p>

<p>The authentication is done by using a JWT which represents the event subscriber. This can be obtained by calling the <a href="https://developer.concur.com/api-reference/authentication/apidoc.html#client_credentials">Client Credentials</a> grant type using your OAuth2 credentials. The JWT generated by this grant will have a <code class="language-plaintext highlighter-rouge">JWT Type</code> of <code class="language-plaintext highlighter-rouge">App</code> where your <code class="language-plaintext highlighter-rouge">Application ID</code> is the <code class="language-plaintext highlighter-rouge">Subject</code> of the Token.</p>

<p>For authorization, the Application needs to contain the scope <code class="language-plaintext highlighter-rouge">events.topic.read</code> in order to access the ESS APIs. This scope will be inherited by the JWT during the Client Credentials Grant which is then checked by the ESS API.</p>

<p>Pass the JWT in the Post Header when making calls to the ESS API:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Authorization: Bearer &lt;JWT&gt;
</code></pre></div></div>
<p>The Client Credentials JWT has a lifetime of 60 minutes and can only be obtained again via the Client Credentials Grant.</p>

<h2 id="-2-browse-available-topics"><a name="get-topics"></a> 2. Browse available topics</h2>
<p>Before you create any subscription you need to verify that you have sufficient access to the topic. If that request returns empty you need to get in touch with your assigned contact from SAP Concur to set proper scopes to your Concur Oauth2 Application.</p>

<p><strong>Request</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /events/v4/topics
</code></pre></div></div>
<p><strong>Response</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="s2">"public.test"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<h2 id="-3-create-a-subscription"><a name="put-subscription"></a> 3. Create a subscription</h2>
<p>To create a subscription you need to</p>
<ol>
  <li>know and have sufficient access to the <strong>topic</strong></li>
  <li>get your receiving <strong>endpoint</strong> running, <a href="https://developer.concur.com/api-reference/common/ess/getting-started.html#endpoint-requirements">endpoint
requirements</a></li>
  <li>come up with unique name (id) of your subscription. Subscription names are globally unique, and you will get an error if name is already occupied.</li>
  <li>set filter to <code class="language-plaintext highlighter-rouge">.*</code> (regexp syntax), you can use it later to filter out unwanted types of events</li>
</ol>

<p><strong>Request</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT /events/v4/subscriptions/webhook
</code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-unique-subscription-id"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="s2">".*"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"public.test"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"webHookConfig"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.concuress.com/sub/my-valid-endpoint"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p><strong>Response</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"message"</span><span class="p">:</span><span class="s2">"Subscription 'my-unique-subscription-id' saved successfully"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="--4-verify-your-subscription"><a name="get-subscription"></a>  4. Verify your subscription</h2>
<p>You can always request a configuration of your subscription. You might notice that your subscription contains some more parameters that you can not modify for security reasons, but can use them for troubleshooting purposes.</p>
<ul>
  <li>applicationId - identifies your Concur Application as an owner of that subscription</li>
  <li>companyIds - a list of UUIDs of companies that allowed your Applicaion to access their data, the process of connecting Concur company to your application is described here (link)</li>
  <li>groups and scope - are used for complex access control scenarios</li>
</ul>

<p><strong>Request</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /events/v4/subscriptions/my-unique-subscription-id
</code></pre></div></div>
<p><strong>Response</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-unique-subscription-id"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"public.test"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="s2">".*"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"webHookConfig"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.concuress.com/sub/my-valid-endpoint"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"applicationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dabd27f0-23e7-415d-b5e5-19a7dbe4fb4d"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
        </span><span class="nl">"groups"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="nl">"companyIds"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>
<h2 id="-5-browse-existing-subscriptions"><a name="get-subscription-list"></a> 5. Browse existing subscriptions</h2>
<p>If you happen to forget your subscription name/id, you can always retrieve all of your subscriptions by calling next endpoint:<br />
<strong>Request</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /events/v4/subscriptions
</code></pre></div></div>
<p><strong>Response</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-second-unique-subscription-id"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"public.test"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="s2">".*"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"webHookConfig"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.concuress.com/sub/my-second-valid-endpoint"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"applicationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dabd27f0-23e7-415d-b5e5-19a7dbe4fb4d"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
        </span><span class="nl">"groups"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="nl">"companyIds"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-unique-subscription-id"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"public.test"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="s2">".*"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"webHookConfig"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.concuress.com/sub/my-valid-endpoint"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"applicationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dabd27f0-23e7-415d-b5e5-19a7dbe4fb4d"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
        </span><span class="nl">"groups"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="nl">"companyIds"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<h2 id="--6-delete-your-subscription"><a name="delete-subscription"></a>  6. Delete your subscription</h2>
<p><strong>Request</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DELETE /events/v4/subscriptions/my-unique-subscription-id
</code></pre></div></div>
<p><strong>Response</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Subscription 'my-unique-subscription-id' marked for deletion"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="--6-request-example"><a name="example"></a>  6. Request Example</h2>

<p><strong>HEADERS</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT /events/v4/subscriptions/webhook HTTP/1.1
Content-Type: application/json
Concur-Correlationid: something-unique-and-trackable
Authorization: Bearer eyJ0e*****MY-SECRET-JWT-HERE******** 
Accept: */*
Cache-Control: no-cache
Host: www-us.api.concursolutions.com
Accept-Encoding: gzip, deflate
Connection: keep-alive
</code></pre></div></div>
<p><strong>BODY</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "id": "my-unique-subscription-example",
  "filter": ".*",
  "topic": "public.test",
  "webHookConfig": {"endpoint": "https://www.concuress.com/sub/my-unique-endpoint" }
}
</code></pre></div></div>

<p>CURL Code</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X PUT \
  https://www-us.api.concursolutions.com/events/v4/subscriptions/webhook \
  -H 'Accept: */*' \
  -H 'Accept-Encoding: gzip, deflate' \
  -H 'Authorization: Bearer eyJ0e*****MY-SECRET-JWT-HERE********' \
  -H 'Cache-Control: no-cache' \
  -H 'Concur-Correlationid: something-unique-and-trackable' \
  -H 'Connection: keep-alive' \
  -H 'Content-Type: application/json' \
  -H 'Host: www-us.api.concursolutions.com' \
  -H 'cache-control: no-cache' \
  -d '{
  "id": "my-unique-subscription-example-2",
  "filter": ".*",
  "topic": "public.test",
  "webHookConfig": {
    "endpoint": "https://www.concuress.com/sub/my-unique-endpoint"
  }
}'
</code></pre></div></div>

:ET